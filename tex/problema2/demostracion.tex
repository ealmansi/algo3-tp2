Primero vamos a demostrar que un bosque generador mínimo con k componentes conexas resuelve el problema. Osea que todos los pueblos estan conectados y su máxima arista es la mínima entre todas las soluciones posibles.

Cabe aclarar que como estamos el peso de una arista es la distancia entre sus dos extremos, los pesos de las arista nunca van a ser negativos.

Para eso primero vamos a demostrar los siguiente lemas:

\textbf{Lema 1:} Un bosque de k componentes conexas generador mínimo tambien minimiza la máxima arista.

\textbf{Lema 2:} G grafo es solucion $\Leftrightarrow \#$ (componentes conexas (G)) $\leq$ k. Osea,  G(V,E) grafo y C un conjunto de k vertices $\in $ V q.v.q. $(\forall v \in V)(\exists c \in C)$ v esta conecado a c $\Leftrightarrow \#$ (componentes conexas (G)) $\leq$ k

\textbf{Lema 3:} Dada una solucions con C componentes conexas (C $<$ k), existe una solucion mejor o igual con C+1 componentes conexas. \\ \\ 


\textbf{Lema 1:} Un bosque de k componentes conexas generador mínimo tambien minimiza la máxima arista. Equivalentemente, sea B un bosque de k componentes conexas generador mínimo $(\nexists$ G subgrafo generador con k componentes conexas) MaxArista(G) $<$ MaxArista(B).

Por el absurdo, sea B(V,E) un bosque de k componentes conexas generador mínimo supongo que existe un G(N,A) subgrafo generador con k componentes conexastal que MaxArista(G) < MaxArista(B).

Sea e la MaxArista(B), sabemos que toda arista en en G va a ser menor que e.

Si las k componentes conexas de B y G son las mismas:

Sea B'(V,E-e), tiene k-1 componentes conexas iguales a las de B, y C,la componente en la que estaba e, se divide en dos componentes conexas C1 y C2, ambas árboles.

Como G tiene las mismas componentes conexas que B, C es una componente conexa de G.Por lo cual existe una arista e' con un extremo en C1 y otro en C2.

Sea B''(V,E-e+e') B'' es un subgrafo generador con k componentes conexas ya que al quitar e se generan un subgrafo con k+1 componentes conexas. Y al agregar e', como este  tiene extremos en dos componente conexa diferentes, quedan k componentes conexas. Y como no se modifican los vertices sigue siendo generador.

Sabemos que $f(e') < f(e) $por e' pertenecer a G $\Rightarrow f(e') - f(e) < 0$

$\sum_{i \in E-e+e'} f(i) = \sum_{i \in E} f(i) - f(e) + f(e') < \sum_{i \in E} f(i)$.

Tambien sabemos que $\sum_{i \in E} f(i) \leq \sum_{i \in E-e+e'} f(i)$ ya que B es un bosque de k componentes conexas generador mínimo.

Entonces: $\sum_{i \in E} f(i) > \sum_{i \in E-e+e'} f(i) \wedge \sum_{i \in E} f(i) \leq \sum_{i \in E-e+e'} f(i)$
Lo cual es absurdo.

El otro caso es que G tenga aunque sea dos componentes conexas diferentes:

Si las componentes conexas de G son diferentes a las de B, entonces existe en G una arista e' tal que cada extremo de la arista pertenece a componentes conexas diferentes de B (Sino terndría las mismas componentes conexas).

Sea B''(V,E-e+e') igual que en el caso anterior B'' es un subgrafo generador con k componentes conexas.

Y de la misma manera que en el caso anterior se llega a un absurdo.

abemos que $f(e') < f(e) $por e' pertenecer a G $\Rightarrow f(e') - f(e) < 0$

$\sum_{i \in E-e+e'} f(i) = \sum_{i \in E} f(i) - f(e) + f(e') < \sum_{i \in E} f(i)$.

Tambien sabemos que $\sum_{i \in E} f(i) \leq \sum_{i \in E-e+e'} f(i)$ ya que B es un bosque de k componentes conexas generador mínimo.

Entonces: $\sum_{i \in E} f(i) > \sum_{i \in E-e+e'} f(i) \wedge \sum_{i \in E} f(i) \leq \sum_{i \in E-e+e'} f(i)$. \\ \\


\textbf{Lema 2:} G(V,E) grafo y C un conjunto de k vertices $\in $ V q.v.q. $(\forall v \in V)(\exists c \in C)$ v esta conecado a c $\Leftrightarrow \#$ (componentes conexas (G)) $\leq$ k

Sea k' la cantidad de $\#$ (componentes conexas (G)).

Primero probemos $\Leftarrow$

Tomo $c_i \in S_i$ con $c_i$ el i-esimo vertice de C y $S_i$ la i-esima componente conexa de S para $1 \leq i \leq k'$ puedo elegir k' elemento porque C tiene k elementos y k' $\leq$ k.

Ahora tomo cualquier v $\in$ V, sea $S_j$ la componente conexa de G a la que v pertenece. Existe un camino entre v y $c_j$ ya que ambos pertenecen a la misma componente conexa.

Ahora probemos $\Rightarrow$
Para esto probaremos el contra reciproco:

$\#$ (componentes conexas (G)) $>$ k  $\Leftrightarrow$ $(\exists v \in V)(! \exists c \in C)$ v esta conecado a c. 

Sea ${v_1,...,v_{k'}}$ un conjuntos de vertices de V tal que $v_i \in S_i$. $(\forall 1 \leq i,j \leq k', i \neq j)$ no existe camino entre $v_i$ y $v_j$, ya que pertenecen a componentes conexas diferentes.

Ahora tomo cada uno de los $c_i \in$ C y los asocio al $v_j$ / exista un camino entre $c_i$ y $v_j$. Veamos que un $c_i$ no puede estar asociado a dos v diferentes. ya que si existe un camino entre $c_i$ y $v_j$ y tambien entre $c_i$ y $v_q$ tambien existira el camino entre $v_j$ y $v_q$ lo cual es absurdo salvo que j = q.

Cuando terminamos de asignar los k $c_i$ tendremos a lo sumo (ya que dos c diferentes si pueden corresponder al mismo v) k $v_i$ con un c asignado. Pero como k $<$ k' tendremos como mínimo un $v_i$ que no esta conectado a ningun c. Demostrando asi el lema. \\ \\


\textbf{Lema 3:} Dada una solucions con C componentes conexas (C $<$ k), existe una solucion mejor o igual con C+1 componentes conexas.

Tomo una solución G(V,E) con C componentes conexas (C $<$ k), Sea e $\in$ E y G'(V,E-e).
Primero veamos que G' es solucion, como G tenia C componentes conexas, G' tiene a lo sumo C+1. Como C $<$ k $\Rightarrow$ C+1 $\leq$ k. Por el \textbf{Lema 2} G' es solución. 
Ahora quiero ver que es mejor o igual que G.
G' es mejor o igual que G $\Leftrightarrow$ MaxArista(G') $\leq$ MaxArista(G).
Como las aristas de G' estan incluidas en las de G, no puede existir una arista de G' que sea mayor a la máxima arista de G.
Entonces probamos G' es mejor o igual que G. \\ \\

Ahora utilizando los 2 y 3 lemas, se llega a que siempre existe una solución optima con k componentes conexas.
Ya que por 2 si tiene menos que k no puede ser solución, y por 3 si tiene mas que k siempre se puede encontrar una mejor o igual con k.

Ahora usando el lema uno sabemos que entre todas las soluciones posibles con k componentes conexas, el bosque generador mínimo es óptimo.

Por lo cual concluimos que el bosque generador mínimo con k componentes conexas es una solución óptima para nuestro problema.

Ahora demostraremos que nuestro algoritmo realmente calcula un bosque de k componentes conexas generador mínimo.

\textbf{Lema 4:} Dado B(V,E) un boque generador mínimo con k componentes conexas y e su arista máxima, B'(V,E-e) es un bosque generador mínimo con k+1 componentes conexas.

Primero veamos que B'(V,E-e) es un boque generador con k+1 componentes conexas. Es un subgrafo generador ya que sus vertices son V, los mismos que los de B que era un subgrafo generador. Y es un bosque con k+1 componentes conexas ya que las k-1 componentes conexas de B a las que e no pertenecia se mantienen igual, y a la que pertenecia e (que era tambien un árbol), se divide en dos componentes conexas, cada una un árbol. Lo que nos genera un bosque con k+1 componentes conexas.

Ahora veamos que es mínimo, supongo por el absurdo que existe un subgrafo generador con k+1 componentes conexas G(V,E') tal que $\sum_{i \in E'} f(i) < \sum_{i \in E-e} f(i)$.

Si G tiene las mismas componentes conexas que B' entonces G'(V, E'+e) es un subgrafo generador con k componentes conexas, cada extremo de e pertenece a un componente conexa diferente en G.

$\sum_{i \in E'+e} f(i) = \sum_{i \in E'} f(i) + f(e) < \sum_{i \in E-e} f(i) + f(e) = \sum_{i \in E} f(i)$

Lo cual es absurdo ya que $\sum_{i \in E} f(i) \leq \sum_{i \in E'+e} f(i)$ por ser B mínimo.

El otro caso posible es que las componentes conexas de G sean diferentes de las de B', entonces existe un a $\in$ E-e tal que cada extremo de a pertence a componentes conexas distintas de G(sino tendía las mismas componentes conexas que B').

Sea G'(V,E'+ a) por la misma razon que el caso anterior, G' es un subgrafo generador con k componentes conexas.

$\sum_{i \in E'+a} f(i) = \sum_{i \in E'} f(i) + f(a) < \sum_{i \in E-e} f(i) + f(a) \leq \sum_{i \in E} f(i)$ ya que f(a) $\leq$ f(e) por ser e la máxima arista en E.

Lo cual es absurdo igual que en el caso anterior porque $\sum_{i \in E} f(i) \leq \sum_{i \in E'+e} f(i)$ por ser B mínimo.

Ahora veamos que nuestro algoritmo consigue un bosque de k componentes conexas generador mínimo.

\begin{pseudo}
\State Tipo de dato Pueblo es Tupla $\langle$ x : entero, y : entero $\rangle$
\State Tipo de dato Conexion es Tupla $\langle p_1 : Pueblo, p_2 : Pueblo \rangle$
    \Procedure{La centralita}{$\langle Pueblo_1 , \ldots , Pueblo_n \rangle , k$}
        \State $Pueblos \leftarrow$ nuevo conjunto de Pueblo \Ode{1}
        \State Cargo\_Pueblos(Pueblos) \Ode{n}
        \State $Conexiones \leftarrow$ nuevo conjunto de Conexion \Ode{1}
        \State Conexiones = Prim(Pueblos) \Ode{n^2}
        \State Sort(Conexiones) \Ode{n*log(n)}
        \For 1 to min(k,n)-1 \Ode{min(k,n)}
	  \State Eliminar máximo Conexiones \Ode{1}
	\EndFor
        \State Centrales $\leftarrow$ nuevo conjunto de Pueblo \Ode{1}
        %TODO mejorar esta parte
        \While no viste p $\in$ Pueblos
        \State agregar p a Centrales
        \State BFS(p,Pueblos)
        \EndWhile
        %\Comment Este sort se hace de menor a mayor según el coeficiente anteriormente dicho
        \State \textbf{return} Centrales,Conexiones \Ode{n}
    \EndProcedure
\end{pseudo}

Prim nos genera el árbol generador mínimo, que tambien puede ser considerado un bosque genrador mínimo con una componente conexa. Por el \textbf{Lema 4}, cada vez que quitamos la arista máxima nos queda un bosque generador mínimo con una componente conexa más, al hacerlo k-1 veces nos queda el bosque generador mínimo con k componentes conexas.

Ahora solo nos queda lograr distinguir esas k componentes conexas para construir una central en algun vértice de cada una de las componentes conexas. Por esto, mientras no hayamos encontrado todas las componentes conexas, incluimos un nodo todavia no alcnazado a la lista de centrales y utilizamos BFS desde ese nodo, ya que encuentra todos los nodos en una componente conexa.